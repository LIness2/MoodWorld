import requests
from pymongo import MongoClient

API_KEY = "4aa659261bd2443997ffc38ef5c851fd"  # Remplace par ta clé API
URL = "https://newsapi.org/v2/everything"

def get_articles(query="politique", language="fr", page_size=10):
    """ Récupère des articles d’actualité et les structure en JSON. """
    params = {
        "q": query,
        "language": language,
        "pageSize": page_size,
        "apiKey": API_KEY
    }

    response = requests.get(URL, params=params)
    data = response.json()

    if data["status"] != "ok":
        print("Erreur :", data)
        return []

    # Structuration des articles sous forme de documents JSON
    articles = [
        {
            "title": article["title"],
            "author": article.get("author", "Inconnu"),
            "publication_date": article["publishedAt"],
            "content": article.get("content", "Aucun contenu"),
            "url": article["url"],
            "source": article["source"]["name"],
            "tags": query
        }
        for article in data["articles"]
    ]

    return articles  # Retourne une liste de dictionnaires JSON

# Test : récupérer 5 articles
articles_json = get_articles("climat", "fr", 5)
print(articles_json)

def save_articles_to_mongo(articles):
    """ Sauvegarde une liste d'articles dans MongoDB. """
    # Connexion à MongoDB
    client = MongoClient('mongodb://localhost:27017/')
    db = client['articles_db']
    articles_collection = db['articles']

    if articles:
        articles_collection.insert_many(articles)
        print(f"{len(articles)} articles sauvegardés dans MongoDB.")
    else:
        print("Aucun article à enregistrer.")

# Sauvegarde des articles récupérés
save_articles_to_mongo(articles_json)
