import streamlit as st
import pandas as pd
import plotly.express as px
from pymongo import MongoClient

# Connexion MongoDB
client = MongoClient("mongodb://localhost:27017/")
db = client["articles_db"]
collection = db["articles"]

# Liste complète des émotions
emotions = ["joy", "sadness", "anger", "fear", "surprise", "disgust"]

# Récupération des thèmes et pays
themes = collection.distinct("tags")
pays_list = collection.distinct("pays")

st.title("Comparaison des émotions par pays, thème et année")

# Widgets Streamlit
selected_theme = st.selectbox("Choisir un thème :", themes)

selected_countries = st.multiselect(
    "Choisir 3 pays :", pays_list, default=pays_list[:3]
)
# Vérification
if len(selected_countries) != 3:
    st.warning("Veuillez sélectionner exactement 3 pays.")
else:
    data = []

    for pays in selected_countries:
        articles = collection.find({
            "tags": selected_theme,
            "pays": pays,
            "publication_date": {"$regex": f"^{selected_year}"}
        })

        counts = {e: 0 for e in emotions}
        for article in articles:
            emotion = article.get("emotion")
            if emotion in emotions:
                counts[emotion] += 1

        for emotion in emotions:
            data.append({
                "Pays": pays,
                "Emotion": emotion,
                "Nombre d'articles": counts[emotion]
            })

    df = pd.DataFrame(data)

    fig = px.bar(
        df,
        x="Pays",
        y="Nombre d'articles",
        color="Emotion",
        category_orders={"Emotion": emotions},
        barmode="stack",
        title=f"Émotions par pays – Thème '{selected_theme}' ({selected_year})",
        color_discrete_map={
            "joy": "#E1BB60",
            "sadness": "#6998C5",
            "anger": "#D84644",
            "fear": "#C49DD9",
            "surprise": "#E09F6D",
            "disgust": "#3B9A3B",
             "neutral": "#CFCFCF"
        }
    )

    st.plotly_chart(fig, use_container_width=True)

